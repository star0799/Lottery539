name: Build and Package WinForms App

on:
  push:
    branches:
      - master

# 需要寫入 release
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Set version
        id: set-version
        shell: pwsh
        run: |
          $version = Get-Date -Format "yyyyMMddHHmmss"
          "version=$version" >> $env:GITHUB_OUTPUT

      - name: Build
        shell: pwsh
        run: |
          nuget restore Lottery539.sln
          msbuild Lottery539.sln /p:Configuration=Release /p:Version=${{ steps.set-version.outputs.version }}

      - name: Publish
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path publish | Out-Null
          Copy-Item -Path .\bin\Release\* -Destination .\publish\ -Recurse -Force
          "${{ steps.set-version.outputs.version }}" | Out-File -FilePath .\publish\version.txt -Encoding utf8

      - name: Package
        shell: pwsh
        run: |
          if (Test-Path .\output.zip) { Remove-Item .\output.zip -Force }
          Compress-Archive -Path publish -DestinationPath output.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: winforms-app
          path: output.zip
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: winforms-app
          path: .

      - name: Set version
        id: set-version
        run: |
          unzip -o output.zip -d extracted
          ver="$(cat extracted/publish/version.txt)"
          echo "version=$ver" >> "$GITHUB_OUTPUT"
          echo "Version: $ver"

      - name: Create Release & Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.set-version.outputs.version }}
          name: Release ${{ steps.set-version.outputs.version }}
          files: output.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload version.txt as artifact
        uses: actions/upload-artifact@v4
        with:
          name: version-info
          path: extracted/publish/version.txt
          if-no-files-found: error
